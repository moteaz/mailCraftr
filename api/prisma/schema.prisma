generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id       Int    @id @default(autoincrement())
  email    String @unique
  password String
  role     Role   @default(USER)

  ownedProjects Project[]      @relation("UserOwnedProjects")
  projects      Project[]      @relation("UserProjects")
  categories    Categorie[]
  webhooks      Webhook[]
  refreshTokens RefreshToken[]

  createdAt DateTime @default(now())

  @@index([role])
}

model Project {
  id          Int     @id @default(autoincrement())
  title       String  @unique
  description String?
  ownerId     Int

  owner      User        @relation("UserOwnedProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  users      User[]      @relation("UserProjects")
  categories Categorie[]

  createdAt DateTime @default(now())
}

model Categorie {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  projectId   Int
  createdById Int

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User       @relation(fields: [createdById], references: [id], onDelete: Cascade)
  templates Template[]

  createdAt DateTime @default(now())

  @@unique([name, projectId])
}

model Template {
  id           Int     @id @default(autoincrement())
  name         String
  description  String?
  content      String
  placeholders String  @default("[]")
  categorieId  Int

  categorie Categorie @relation(fields: [categorieId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([name, categorieId])
}

// Many-to-Many pivot table created automatically by Prisma

model Webhook {
  id        Int      @id @default(autoincrement())
  url       String
  events    String   // JSON array of event names
  secret    String?  // Optional secret for signature verification
  active    Boolean  @default(true)
  createdBy Int
  user      User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

enum Role {
  SUPERADMIN
  USER
}
